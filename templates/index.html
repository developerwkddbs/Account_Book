<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>가계부</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>가계부</h1>
        <br>
        <h3>기간 조회</h3>
        <form method="get" action="/">
            <input type="text" id="start_date" name="start_date" placeholder="시작일 선택">
            <input type="text" id="end_date" name="end_date" placeholder="종료일 선택">
            <button type="submit">조회</button>
            <a href="/">초기화</a>
        </form>
        <hr>

        <div class="card">
            <p>총 수입: {{ total_income }} 원</p>
            <p>총 지출: {{ total_expense }} 원</p>
            <h3>현재 잔액: {{ balance }} 원</h3>
        </div>

        <form method="POST" action="/add">
            <select name="type" id="typeSelect">
                <option value="income">수입</option>
                <option value="expense">지출</option>
            </select>

            <select name="memo" id="usageSelect" required></select>
            <input type="text" name="detail" placeholder="상세내역"/>
            <input type="number" name="amount" placeholder="금액" required>
            <button type="submit">추가</button>
        </form>

        <h2>내역</h2>
        <table border="1">
            <tr>
                <th>구분</th>
                <th>금액</th>
                <th>사용처</th>
                <th>상세내역</th>
                <th>날짜</th>
                <th>삭제</th>
            </tr>
            {% for r in records %}
            <tr>
                <td>
                    {% if r[1] == 'income' %}
                        <span class="badge-income">수입</span>
                    {% elif r[1] == 'expense' %}
                        <span class="badge-expense">지출</span>
                    {% else %}
                        {{ r[1] }}
                    {% endif %}
                </td>
                <td>{{ r[2] }}</td>  <!-- 금액 -->
                <td>{{ r[3] }}</td>  <!-- 사용처 -->
                <td>{{ r[4] or '-' }}</td>  <!-- 상세내역 -->
                <td>{{ r[5] }}</td>  <!-- 날짜 -->
                <td>
                    <a href="{{ url_for('delete', record_id=r[0]) }}"
                       onclick="return confirm('해당 기록을 삭제하시겠습니까?');">
                        삭제
                    </a>
                </td>
            </tr>
            {% endfor %}
        </table>

        <br><br>

        <h2>수입 + 지출 항목 비율</h2>
        <div class="chart-wrapper">
            <canvas id="allPie"></canvas>
        </div>

    </div>
    <script>
        //수입/지출 원그래프
        fetch("/stats/all_pie")
            .then(res => res.json())
            .then(data => {
                const el = document.getElementById("allPie");
                if (!el) return;

                // 색상 자동 생성
                const backgroundColors = data.labels.map(label => {
                if (label.startsWith("수입")) {
                    // 파란 계열 (수입)
                    return `rgba(54, 162, 235, 0.7)`;
                } else {
                    // 빨간 계열 (지출)
                    return `rgba(255, 99, 132, 0.7)`;
                }
                });

                const borderColors = data.labels.map(label => {
                if (label.startsWith("수입")) {
                    return `rgba(54, 162, 235, 1)`;
                } else {
                    return `rgba(255, 99, 132, 1)`;
                }
                });

                new Chart(el.getContext("2d"), {
                type: "pie",
                data: {
                    labels: data.labels,
                    datasets: [{
                    data: data.data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                    legend: { position: "bottom" }
                    }
                }
                });
            });
        
        //날짜 선택기
        flatpickr("#start_date", {
            locale: "ko",
            dateFormat: "Y-m-d",
            monthSelectorType: "static"
        });

        flatpickr("#end_date", {
            locale: "ko",
            dateFormat: "Y-m-d",
             monthSelectorType: "static"
        });

        // 사용처 option (그룹)
        const incomeGroups = {
            "정기": ["월급", "용돈"],
            "비정기": ["상여금", "환급/캐시백", "부수입"],
            "기타": ["기타수입"]
        };

        const expenseGroups = {
            "필수": ["식비", "생활비", "교통비", "교육/교재", "정기구독","회비"],
            "선택": ["카페/간식", "쇼핑", "취미/여가", "미용/화장"],
            "건강": ["의료/건강"],
            "기타": ["기타지출"]
        };

        const typeSelect = document.getElementById("typeSelect");
        const usageSelect = document.getElementById("usageSelect");

        function setOptionsWithGroups(groups) {
            usageSelect.innerHTML = "";

            // 기본 안내 옵션
            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "사용처 선택";
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            usageSelect.appendChild(defaultOpt);

            // 그룹별 옵션 추가
            Object.entries(groups).forEach(([groupName, items]) => {
                const og = document.createElement("optgroup");
                og.label = groupName;

                items.forEach(text => {
                    const opt = document.createElement("option");
                    opt.value = text;
                    opt.textContent = text;
                    og.appendChild(opt);
                });

                usageSelect.appendChild(og);
            });
        }

        function updateUsageOptions() {
            const type = typeSelect.value;
            if (type === "income") setOptionsWithGroups(incomeGroups);
            else setOptionsWithGroups(expenseGroups);
        }

        typeSelect.addEventListener("change", updateUsageOptions);
        updateUsageOptions(); // 페이지 로드시 한번 세팅        
    </script>
</body>
</html>
