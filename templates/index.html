<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>가계부</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>가계부</h1>
        <br>
        <h3>기간 조회</h3>
        <form method="get" action="/">
            <input type="text" id="start_date" name="start_date" placeholder="시작일 선택">
            <input type="text" id="end_date" name="end_date" placeholder="종료일 선택">
            <button type="submit">조회</button>
            <a href="/">초기화</a>
        </form>
        <hr>

        <div class="card">
            <p>총 수입: {{ total_income }} 원</p>
            <p>총 지출: {{ total_expense }} 원</p>
            <h3>현재 잔액: {{ balance }} 원</h3>
        </div>

        <form method="POST" action="/add">
            <select name="type" id="typeSelect">
                <option value="income">수입</option>
                <option value="expense">지출</option>
            </select>

            <select name="memo" id="usageSelect" required></select>
            <input type="text" name="amount" id="amountInput" placeholder="금액" required>
            <input type="text" name="detail" placeholder="상세내역"/>
            <button type="submit">추가</button>
        </form>

        <h2>내역</h2>
        <table border="1">
            <tr>
                <th>구분</th>
                <th>금액</th>
                <th>사용처</th>
                <th>상세내역</th>
                <th>날짜</th>
                <th>삭제</th>
            </tr>
            {% for r in records %}
            <tr>
                <td>
                    {% if r[1] == 'income' %}
                        <span class="badge-income">수입</span>
                    {% elif r[1] == 'expense' %}
                        <span class="badge-expense">지출</span>
                    {% else %}
                        {{ r[1] }}
                    {% endif %}
                </td>
                <td>{{ "{:,}".format(r[2])+"원" }}</td>
                <td>{{ r[3] }}</td>  <!-- 사용처 -->
                <td>
                    <form method="post" action="{{ url_for('update_detail', record_id=r[0]) }}"
                        style="display:flex; gap:6px; justify-content:center; align-items:center;">
                    <input type="text" name="detail" value="{{ r[4] or '' }}" placeholder="상세내역"
                        style="padding:6px 8px; border:1px solid #ccc; border-radius:6px; width: 180px;">
                    <button type="submit" style="padding:6px 10px; border-radius:6px; cursor:pointer;">
                    저장
                    </button>
                </form>
                </td>
                <td>{{ r[5] }}</td>  <!-- 날짜 -->
                <td>
                    <a href="{{ url_for('delete', record_id=r[0]) }}"
                       onclick="return confirm('해당 기록을 삭제하시겠습니까?');">
                        삭제
                    </a>
                </td>
            </tr>
            {% endfor %}
        </table>

        <br><br>

        <h2>수입 + 지출 항목 비율</h2>
        <div class="chart-wrapper">
            <canvas id="allPie"></canvas>

            <label style="display:flex; gap:8px; align-items:center; margin:10px 0;">
                <span>월 선택</span>
                <input type="month" id="pieMonth">
            </label>
        </div>
    </div>
    <script>
        let allPieChart = null;

        function loadMonthPie(month) {
            fetch(`/stats/month_pie?month=${encodeURIComponent(month)}`)
            .then(res => res.json())
            .then(data => {
                const el = document.getElementById("allPie");
                if (!el) return;

                const backgroundColors = data.labels.map(label =>
                label.startsWith("수입") ? "rgba(54, 162, 235, 0.7)" : "rgba(255, 99, 132, 0.7)"
                );
                const borderColors = data.labels.map(label =>
                label.startsWith("수입") ? "rgba(54, 162, 235, 1)" : "rgba(255, 99, 132, 1)"
                );

                // 최초 1회 생성
                if (!allPieChart) {
                allPieChart = new Chart(el.getContext("2d"), {
                    type: "pie",
                    data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                    },
                    options: {
                    responsive: true,
                    plugins: { legend: { position: "bottom" } }
                    }
                });
                return;
                }

                // 이후엔 "삭제" 말고 데이터만 갱신
                allPieChart.data.labels = data.labels;
                allPieChart.data.datasets[0].data = data.data;
                allPieChart.data.datasets[0].backgroundColor = backgroundColors;
                allPieChart.data.datasets[0].borderColor = borderColors;
                allPieChart.update();
            });
        }

        // 월 input 기본값: 이번 달
        const pieMonth = document.getElementById("pieMonth");
        if (pieMonth) {
            const now = new Date();
            pieMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;

            // 처음 로드시 이번 달 차트
            loadMonthPie(pieMonth.value);

            // 월 바꾸면 해당 월 차트로 전환
            pieMonth.addEventListener("change", () => {
            loadMonthPie(pieMonth.value);
            });
        }
        
        //날짜 선택기
        flatpickr("#start_date", {
            locale: "ko",
            dateFormat: "Y-m-d",
            monthSelectorType: "static"
        });

        flatpickr("#end_date", {
            locale: "ko",
            dateFormat: "Y-m-d",
             monthSelectorType: "static"
        });

        // 사용처 option (그룹)
        const incomeGroups = {
            "정기": ["월급", "용돈"],
            "비정기": ["상여금", "환급/캐시백", "부수입"],
            "기타": ["기타수입"]
        };

        const expenseGroups = {
            "필수": ["식비", "생활비", "교통비", "교육/교재", "정기구독","회비"],
            "선택": ["카페/간식", "쇼핑", "취미/여가", "미용/화장"],
            "건강": ["의료/건강"],
            "기타": ["기타지출"]
        };

        const typeSelect = document.getElementById("typeSelect");
        const usageSelect = document.getElementById("usageSelect");

        function setOptionsWithGroups(groups) {
            usageSelect.innerHTML = "";

            // 기본 안내 옵션
            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "사용처 선택";
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            usageSelect.appendChild(defaultOpt);

            // 그룹별 옵션 추가
            Object.entries(groups).forEach(([groupName, items]) => {
                const og = document.createElement("optgroup");
                og.label = groupName;

                items.forEach(text => {
                    const opt = document.createElement("option");
                    opt.value = text;
                    opt.textContent = text;
                    og.appendChild(opt);
                });

                usageSelect.appendChild(og);
            });
        }

        function updateUsageOptions() {
            const type = typeSelect.value;
            if (type === "income") setOptionsWithGroups(incomeGroups);
            else setOptionsWithGroups(expenseGroups);
        }

        typeSelect.addEventListener("change", updateUsageOptions);
        updateUsageOptions(); // 페이지 로드시 한번 세팅      
        
        const amountInput=document.getElementById("amountInput");

        if(amountInput){
            amountInput.addEventListener("input",()=>{
                let value=amountInput.value.replace(/,/g,"");
                if(!isNaN(value) && value !== ""){
                    amountInput.value=Number(value).toLocaleString();
                }
            })
        }
    </script>
</body>
</html>
